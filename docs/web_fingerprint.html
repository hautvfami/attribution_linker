<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Fingerprint Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/1.0.2/ua-parser.min.js"></script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h1 class="card-title mb-0 text-center">üîç Web Browser Fingerprint</h1>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <button class="btn btn-primary btn-lg" onclick="collectFingerprint()">
                                <i class="bi bi-fingerprint"></i> Collect Fingerprint
                            </button>
                        </div>
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Same fingerprint function as used in Flutter WebView
        async function parseFingerprintInfo() {
            const ua = navigator.userAgent || '';
            const uaData = navigator.userAgentData;

            // üß† ∆Øu ti√™n entropy cao n·∫øu c√≥ h·ªó tr·ª£
            const highEntropy = uaData?.getHighEntropyValues
                ? await uaData.getHighEntropyValues([
                    "platform", "platformVersion", "architecture", "model", "uaFullVersion", "bitness", "fullVersionList"
                ])
                : null;

            // üì¶ D√πng UAParser.js
            const parser = new UAParser(ua);
            const parsed = parser.getResult();

            // üì± Ph√¢n lo·∫°i h·ªá ƒëi·ªÅu h√†nh
            function detectOS() {
                const p = (highEntropy?.platform || parsed.os.name || '').toLowerCase();
                if (p.includes('android')) return 'android';
                if (p.includes('ios')) return 'ios';
                if (p.includes('ipad')) return 'ipados';
                if (p.includes('mac')) return 'macos';
                if (p.includes('win')) return 'windows';
                if (p.includes('linux')) return 'linux';
                return 'others';
            }

            const osType = detectOS();

            // üåô Ph√°t hi·ªán h·ªá th·ªëng s√°ng/t·ªëi
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const systemBrightness = prefersDark ? 'dark' : 'light';

            // ‚úÖ Tr·∫£i ph·∫≥ng d·ªØ li·ªáu fingerprint
            const fingerprint = {
                os_type: osType,
                os_name: highEntropy?.platform || parsed.os.name || '',
                os_version: highEntropy?.platformVersion || parsed.os.version || '',
                browser_name: parsed.browser.name || '',
                browser_version: highEntropy?.uaFullVersion || parsed.browser.version || '',
                device_model: highEntropy?.model || parsed.device.model || '',
                device_type: parsed.device.type || '',
                device_arch: highEntropy?.architecture || '',
                device_bitness: highEntropy?.bitness || '',
                screen_res: `${screen.width}x${screen.height}`,
                pixel_ratio: window.devicePixelRatio || 1,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
                language: navigator.language || '',
                cpu_cores: navigator.hardwareConcurrency?.toString() || '',
                device_memory: navigator.deviceMemory?.toString() || '',
                system_brightness: systemBrightness,
                user_agent: ua,
                user_agent_data: uaData || null,
                user_agent_parsed: parsed,
                browser_full_version_list: highEntropy?.fullVersionList?.map(b => `${b.brand}/${b.version}`).join(', ') || ''
            };

            return fingerprint;
        }

        // Function to collect and display fingerprint
        async function collectFingerprint() {
            try {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Collecting fingerprint data...</p></div>';
                
                // Use the parseFingerprintInfo function from fingerprint.js
                const fingerprint = await parseFingerprintInfo();
                
                // Get IP address from API
                const ipData = await getIPAddress();
                
                // Generate trusted_dimension
                const trustedDimension = generateTrustedDimension(ipData.ip, fingerprint);
                
                // Build complete HTML
                let html = `
                    <div class="alert alert-success" role="alert">
                        <h4 class="alert-heading">üîë Trusted Dimension</h4>
                        <hr>
                        <p class="mb-0 font-monospace fw-bold text-break">${trustedDimension}</p>
                    </div>
                    
                    <h3 class="mt-4 mb-3">üìä Fingerprint Results:</h3>
                    <div class="card">
                        <div class="card-body">
                            <pre class="mb-0" style="max-height: 400px; overflow-y: auto; font-size: 0.9em;">${JSON.stringify(fingerprint, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                // Set complete HTML at once
                resultDiv.innerHTML = html;
                
                // Example: Submit to server
                await submitToServer(fingerprint);
                
            } catch (error) {
                console.error('Error collecting fingerprint:', error);
                document.getElementById('result').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">‚ùå Error</h4>
                        <p class="mb-0">${error.message}</p>
                    </div>
                `;
            }
        }

        // Function to get IP address from API
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error getting IP address:', error);
                return { ip: 'unknown' };
            }
        }

        // Function to generate trusted dimension string
        function generateTrustedDimension(ip, fingerprint) {
            const dimensions = [
                ip || 'unknown',
                fingerprint.os_type || 'unknown',
                fingerprint.os_name || 'unknown', 
                fingerprint.screen_res || 'unknown',
                fingerprint.pixel_ratio?.toString() || 'unknown',
                fingerprint.timezone || 'unknown'
            ];
            
            // Convert to lowercase, remove spaces, join with "-"
            return dimensions
                .map(dim => dim.toString().toLowerCase().replace(/\s+/g, ''))
                .join('-');
        }

        // Example function to submit fingerprint to server
        async function submitToServer(fingerprint) {
            try {
                // Encrypt data (simplified example)
                const encryptedData = simpleEncrypt(fingerprint, 'your-secret-key');
                
                const response = await fetch('https://your-server.com/api/fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        encrypted_fingerprint: encryptedData,
                        timestamp: Date.now(),
                        source: 'web'
                    }),
                });

                if (response.ok) {
                    console.log('Fingerprint submitted successfully');
                } else {
                    console.error('Failed to submit fingerprint');
                }
            } catch (error) {
                console.error('Error submitting fingerprint:', error);
            }
        }

        // Simple encryption function (for demonstration only)
        function simpleEncrypt(data, key) {
            const jsonString = JSON.stringify(data);
            const encrypted = btoa(jsonString); // Base64 encode for simplicity
            return {
                data: encrypted,
                timestamp: Date.now(),
                hash: btoa(encrypted + key) // Simple hash
            };
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
