<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Fingerprint Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/1.0.2/ua-parser.min.js"></script>
</head>
<body>
    <h1>Web Browser Fingerprint</h1>
    <button onclick="collectFingerprint()">Collect Fingerprint</button>
    <div id="result"></div>

    <script>
        // Same fingerprint function as used in Flutter WebView
        async function parseFingerprintInfo() {
            const ua = navigator.userAgent || '';
            const uaData = navigator.userAgentData;

            // 🧠 Ưu tiên entropy cao nếu có hỗ trợ
            const highEntropy = uaData?.getHighEntropyValues
                ? await uaData.getHighEntropyValues([
                    "platform", "platformVersion", "architecture", "model", "uaFullVersion", "bitness", "fullVersionList"
                ])
                : null;

            // 📦 Dùng UAParser.js
            const parser = new UAParser(ua);
            const parsed = parser.getResult();

            // 📱 Phân loại hệ điều hành
            function detectOS() {
                const p = (highEntropy?.platform || parsed.os.name || '').toLowerCase();
                if (p.includes('android')) return 'android';
                if (p.includes('ios')) return 'ios';
                if (p.includes('ipad')) return 'ipados';
                if (p.includes('mac')) return 'macos';
                if (p.includes('win')) return 'windows';
                if (p.includes('linux')) return 'linux';
                return 'others';
            }

            const osType = detectOS();

            // 🌙 Phát hiện hệ thống sáng/tối
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const systemBrightness = prefersDark ? 'dark' : 'light';

            // ✅ Trải phẳng dữ liệu fingerprint
            const fingerprint = {
                os_type: osType,
                os_name: highEntropy?.platform || parsed.os.name || '',
                os_version: highEntropy?.platformVersion || parsed.os.version || '',
                browser_name: parsed.browser.name || '',
                browser_version: highEntropy?.uaFullVersion || parsed.browser.version || '',
                device_model: highEntropy?.model || parsed.device.model || '',
                device_type: parsed.device.type || '',
                device_arch: highEntropy?.architecture || '',
                device_bitness: highEntropy?.bitness || '',
                screen_res: `${screen.width}x${screen.height}`,
                pixel_ratio: window.devicePixelRatio || 1,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
                language: navigator.language || '',
                cpu_cores: navigator.hardwareConcurrency?.toString() || '',
                device_memory: navigator.deviceMemory?.toString() || '',
                system_brightness: systemBrightness,
                user_agent: ua,
                user_agent_data: uaData || null,
                user_agent_parsed: parsed,
                browser_full_version_list: highEntropy?.fullVersionList?.map(b => `${b.brand}/${b.version}`).join(', ') || ''
            };

            return fingerprint;
        }

        // Function to collect and display fingerprint
        async function collectFingerprint() {
            try {
                const fingerprint = await parseFingerprintInfo();
                const resultDiv = document.getElementById('result');
                
                resultDiv.innerHTML = '<h2>Fingerprint Results:</h2>';
                
                for (const [key, value] of Object.entries(fingerprint)) {
                    if (typeof value === 'object' && value !== null) {
                        resultDiv.innerHTML += `<p><strong>${key}:</strong> ${JSON.stringify(value, null, 2)}</p>`;
                    } else {
                        resultDiv.innerHTML += `<p><strong>${key}:</strong> ${value}</p>`;
                    }
                }
                
                // Example: Submit to server
                await submitToServer(fingerprint);
                
            } catch (error) {
                console.error('Error collecting fingerprint:', error);
                document.getElementById('result').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Example function to submit fingerprint to server
        async function submitToServer(fingerprint) {
            try {
                // Encrypt data (simplified example)
                const encryptedData = simpleEncrypt(fingerprint, 'your-secret-key');
                
                const response = await fetch('https://your-server.com/api/fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        encrypted_fingerprint: encryptedData,
                        timestamp: Date.now(),
                        source: 'web'
                    }),
                });

                if (response.ok) {
                    console.log('Fingerprint submitted successfully');
                } else {
                    console.error('Failed to submit fingerprint');
                }
            } catch (error) {
                console.error('Error submitting fingerprint:', error);
            }
        }

        // Simple encryption function (for demonstration only)
        function simpleEncrypt(data, key) {
            const jsonString = JSON.stringify(data);
            const encrypted = btoa(jsonString); // Base64 encode for simplicity
            return {
                data: encrypted,
                timestamp: Date.now(),
                hash: btoa(encrypted + key) // Simple hash
            };
        }
    </script>
</body>
</html>
